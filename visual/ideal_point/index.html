<!DOCTYPE html>
<meta charset="utf-8">
<head>
<title>Ideal Point</title>
  <script type="text/javascript" src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://code.jquery.com/jquery-1.8.3.min.js" type="text/javascript" charset="utf-8"></script>
<script src="jquery.tipsy.js" type="text/javascript" charset="utf-8"></script>
<link rel="stylesheet" href="http://onehackoranother.com/projects/jquery/tipsy/stylesheets/tipsy.css" type="text/css" title="no title" charset="utf-8"/>

<link rel="stylesheet" href="//code.jquery.com/ui/1.11.0/themes/smoothness/jquery-ui.css">
<script src="//code.jquery.com/ui/1.11.0/jquery-ui.js"></script>
<link rel="stylesheet" href="/resources/demos/style.css">

<style type="text/css">

body {
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  margin: auto;
  padding-top: 0px;
  position: relative;
  width: 960px;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
  opacity: 1;
}

.circles { opacity: .5; }

.overlay {
  fill: none;
  pointer-events: all;
}

.tipsy { font-size:20px; margin-top:-40px; margin-left:-240px;}

</style>

</head>
<body>
  <div><H1 align="center"> Ideal Point </H1></div>
  <div align="center"><p>Choose X:
    <select onchange="changeTopic(0)" id="dropBox1">
    <option selected>Foreign</option>
    <option>Education</option>
    <option>Individual property</option>
    <option>Financial</option>
    <option>Military</option>
    <option>Law</option>
    <option>Health service</option>
    <option>Health expenses</option>
    <option>Funds</option>
    <option>Public transportation</option>
    </select>
  &nbsp &nbsp &nbsp
  Choose Y:
    <select onchange="changeTopic(0)" id="dropBox2">
      <option>Foreign</option>
      <option selected>Education</option>
      <option>Individual property</option>
      <option>Financial</option>
      <option>Military</option>
      <option>Law</option>
      <option>Health service</option>
      <option>Health expenses</option>
      <option>Funds</option>
      <option>Public transportation</option>
    </select>
  &nbsp &nbsp &nbsp
  Filter by Representatives:
    <select onchange="changeTopic(2)" id="representDropBox">
      <option selected></option>
      <option>Democratic</option>
      <option>Republican</option>
      <option>Independent</option>
    </select>
  <p>
  Search by Name:
    <input type="text" id="searchBox" onkeydown="if (event.keyCode == 13) document.getElementById('search').click()">
    <input type="button" id="search" value="Search" onclick="changeTopic(1)"/>
  &nbsp &nbsp &nbsp
  Search by State(Abbreviation):
    <input type="text" id="searchStateBox" onkeydown="if (event.keyCode == 13) document.getElementById('searchState').click()">
    <input type="button" id="searchState" value="Search" onclick="changeTopic(3)"/>
    <input type="button" id="reset" value="Reset" onclick="changeTopic(0)">
  </p>
  </div>
<script src="http://d3js.org/d3.v3.min.js"></script>

<script>
// Automaticlly fill the search box.
$(function() {
    var names = [];
    var states = [];
    d3.tsv("data.tsv", function(error, data) {
      data.forEach(function (d) {
        if( $.inArray(d["name"], names) == -1 ) {
          names.push(d["name"]);
        }
        if( $.inArray(d["state"], states) == -1 ) {
          states.push(d["state"]);
        }
      });
    });
    $( "#searchBox" ).autocomplete({
      source: names.sort()
    });
    $( "#searchStateBox" ).autocomplete({
      source: states.sort()
    });
});
</script>
<script>
// References: 1) http://bl.ocks.org/mbostock/3887118#index.html
//             2) http://bl.ocks.org/mbostock/3892928
//             3) http://bl.ocks.org/nsonnad/4481531
//             4) http://bl.ocks.org/d3noob/9576689

// all the topics for user filtering
var topics = ["Foreign", "Education", "Individual property", "Financial", "Military", "Law", "Health service", "Health expenses", "Funds", "Public transportation"]

var parties = ["Democratic", "Republican", "Independent"]

// the chosen two topics by user
var margin = {top: 20, right: 20, bottom: 30, left: 40},
    width = 960 - margin.left - margin.right,
    height = 500 - margin.top - margin.bottom;

var x = d3.scale.linear()
  .range([0, width]);

var y = d3.scale.linear()
    .range([height, 0]);

// var color = d3.scale.category10();

var xAxis = d3.svg.axis()
    .scale(x)
    .orient("bottom");

var yAxis = d3.svg.axis()
    .scale(y)
    .orient("left");

var svg = d3.select("body").append("svg");

// update function
// flag == 3, means search by state
// flag == 2, means filter by presentative
// flag == 1, means search, filter by search name,
// flag == 0, means update. 
var changeTopic = function(flag) {
  var x_topic = document.getElementById('dropBox1').selectedOptions[0].text;
  var y_topic = document.getElementById('dropBox2').selectedOptions[0].text;
  var present = document.getElementById('representDropBox').selectedOptions[0].text;
  var searchName = document.getElementById('searchBox').value;
  var searchState = document.getElementById('searchStateBox').value;

  d3.select("svg").remove();
  var svg = d3.select("body").append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
    .append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
  // loading data
  d3.tsv("data.tsv", function(error, data) {
    data.forEach(function(d) {
      d[x_topic] = +d[x_topic];
      d[y_topic] = +d[y_topic];
    });

    x.domain(d3.extent(data, function(d) { return d[x_topic]; })).nice();
    y.domain(d3.extent(data, function(d) { return d[y_topic]; })).nice();

    svg.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + height + ")")
        .call(xAxis)
      .append("text")
        .attr("class", "label")
        .attr("x", width)
        .attr("y", -6)
        .style("text-anchor", "end")
        .text(x_topic);

    svg.append("g")
        .attr("class", "y axis")
        .call(yAxis)
      .append("text")
        .attr("class", "label")
        .attr("transform", "rotate(-90)")
        .attr("y", 6)
        .attr("dy", ".71em")
        .style("text-anchor", "end")
        .text(y_topic);

    // zoom and drag functions
    var zoom = d3.behavior.zoom()
          .x(x)
          .y(y)
          .scaleExtent([1,20])
          .on("zoom", zoomed);
    svg.call(zoom);
    svg.append("rect")
        .attr("class", "overlay")
        .attr("width", width)
        .attr("height", height);


    if (flag > 0) {
      var circles = svg.selectAll("circle")
        .data(data)
      .enter().append("circle")
        .filter(function(d) { 
          // ignore capital
          lowerName = d.name.toLowerCase();
          searchName = searchName.toLowerCase();
          flags_1 = (lowerName.indexOf(searchName) >= 0);

          if (present == "")
            flags_2 = true;
          else flags_2 = (present.charAt(0) == d.party);

          if (searchState == "") flags_3 = true;
          else {
              lowerState = d.state.toLowerCase();
              searchState = searchState.toLowerCase();
              flags_3 = (lowerState == searchState);
          }
           
          return flags_1 && flags_2 && flags_3;   
        });
    }
    // if (flag == 1) {  // filter by name
    //   var circles = svg.selectAll("circle")
    //     .data(data)
    //   .enter().append("circle")
    //     .filter(function(d) { 
    //       // ignore capital
    //       lowerName = d.name.toLowerCase();
    //       searchName = searchName.toLowerCase();
    //       return lowerName.indexOf(searchName) >= 0; });
    // }
    // else if (flag == 2) { // filter by representative
    //   var circles = svg.selectAll("circle")
    //     .data(data)
    //     .enter().append("circle")
    //       .filter(function(d) {
    //           if (present == "")
    //             return true;
    //           else return (present.charAt(0) == d.party);
    //       });
    // }
    // else if (flag == 3) {
    //   var circles = svg.selectAll("circle")
    //       .data(data)
    //       .enter().append("circle")
    //       .filter(function (d) {
    //           if (searchState == "") return true;
    //           lowerState = d.state.toLowerCase();
    //           searchState = searchState.toLowerCase();
    //           return (lowerState == searchState);
    //       });
    // }
    else {
      var circles = svg.selectAll("circle")
        .data(data)
      .enter().append("circle");
    }

    circles.attr("class", "circles")
        .attr("r", 4)
        .attr("transform", transform)
        .style("fill", function(d) { 
          if (d.party=="D") return "blue";
          else if(d.party=="R") return "red";
          else if(d.party=="I") return "yellow";
        });

    // what to do when we mouse over a bubble
    var mouseOn = function() { 
        var circle = d3.select(this);

        // transition to increase size/opacity of bubble
        circle.transition()
        .duration(800).style("opacity", 1)
        .attr("r", 16).ease("elastic");

        // function to move mouseover item to front of SVG stage, in case
        // another bubble overlaps it
        d3.selection.prototype.moveToFront = function() { 
          return this.each(function() { 
          this.parentNode.appendChild(this); 
          }); 
        };

        // skip this functionality for IE9, which doesn't like it
        if (!$.browser.msie) {
          circle.moveToFront(); 
          }
    };

    // what happens when we leave a bubble? 
    var mouseOff = function() {
        var circle = d3.select(this);

        // go back to original size and opacity
        circle.transition()
        .duration(800).style("opacity", .6)
        .attr("r", 4).ease("elastic");
    };

    circles.on("mouseover", mouseOn);
    circles.on("mouseout", mouseOff);

    // tooltips (using jQuery plugin tipsy)
    circles.append("title")
          .text(function(d) { return d.name + ', ' + d.state; });

    $(".circles").tipsy({ gravity: 's', });

    var legend = svg.selectAll(".legend")
        .data(parties)
      .enter().append("g")
        .attr("class", "legend")
        .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

    legend.append("rect")
        .attr("x", width - 18)
        .attr("width", 18)
        .attr("height", 18)
        .style("fill", function(d) {
          if (d == "Democratic") return "blue";
          else if (d == "Republican") return "red";
          else if (d == "Independent") return "yellow";
        });

    legend.append("text")
        .attr("x", width - 24)
        .attr("y", 9)
        .attr("dy", ".35em")
        .style("text-anchor", "end")
        .text(function(d) { 
          return d;
        });

    function zoomed() {
      svg.select(".x.axis").call(xAxis);
      svg.select(".y.axis").call(yAxis);
      circles.attr("transform", transform);
    }

    function transform(d) {
      return "translate(" + x(d[x_topic]) + "," + y(d[y_topic]) + ")";
    }
  });
};


changeTopic(0)
</script>